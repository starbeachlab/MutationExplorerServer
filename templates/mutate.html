{% extends "base.html" %}


{% block head %}
<style>
    .file-field {
        display: flex;
    }
</style>
{% endblock %}




{% block content %}

<center>
  <br>
  <h3>Define mutations </h3>
</center>

<p class="center-align"><b> Select (click on) one or more of the following options:</b></p>
<br>

<div class="center-align"><span id="error-msg" style="color:red;"> {{error}} </span> </div>
<br>
<br>

<div class="row">
 <form id="submitForm" method="POST" enctype="multipart/form-data" class="col s12"> 

   <ul class="collapsible s12">


	<!-- MANUAL MUTATIONS -->
    <li>
      <div class="collapsible-header grey lighten-3">
	<h5 class="center-align"> Manual mutation definition</h5>
      </div>
      <div class="collapsible-body">

	  <button data-target="modalPDB" class="btn-small modal-trigger grey lighten-1" title="PDB chains" style="float:left;"> available PDB chains</button>
	  <div id="modalPDB" class="modal">
	    <div class="modal-content left-align">
	      <h4> Available PDB chains</h4>
	      <p> The PDB that you uploaded contains the following chains: <div id="chain_list"></div> </p>
	    </div>
	    <div class="modal-footer">
	      <a href="#!" class="modal-close waves-effect waves-green btn-flat">Close</a>
	    </div>
	  </div>								   

	<button data-target="modal1" class="btn-small modal-trigger grey lighten-1" title="Further information" style="float:right;">info</button>
	<!-- Modal Structure -->
	<div id="modal1" class="modal">
	  <div class="modal-content">
	    <h4>Mutate current model</h4>
	    <p>You can mutate the model that you uploaded in previous step using the syntax:<br> CHAIN ':' PDB-RESIDUE-ID AA-TYPE<br>Separate multiple mutations with commas.<br>Example: 'A:12G,B:123A'<br>This would mutate residue with the PDB residue ID 12 in chain A to glycine and residue with the ID 123 in chain B to alanine. </p>
	  </div>
	  <div class="modal-footer">
	    <a href="#!" class="modal-close waves-effect waves-green btn-flat">Close</a>
	  </div>
	</div>

	<br>
	<br>

	<button data-target="modalCode" class="btn-small modal-trigger grey lighten-1" title="PDB chains" style="float:left;">one letter code</button>
	<div id="modalCode" class="modal">
	<div class="modal-content left-align">
		<h4> Amino acid one letter code </h4>

		<table>
			<thead>
				<tr>
					<th>Name</th>
					<th>One letter code</th>
				</tr>
			</thead>

			<tbody>
				<tr>
					<th>Alanine</th>
					<th>A</th>
				</tr>
				<tr>
					<th>Arginine</th>
					<th>R</th>
				</tr>
				<tr>
					<th>Asparagine</th>
					<th>N</th>
				</tr>
				<tr>
					<th>Aspartic Acid</th>
					<th>D</th>
				</tr>
				<tr>
					<th>Cysteine</th>
					<th>C</th>
				</tr>
				<tr>
					<th>Gluatmic Acid</th>
					<th>E</th>
				</tr>
				<tr>
					<th>Glutamine</th>
					<th>Q</th>
				</tr>
				<tr>
					<th>Glycine</th>
					<th>G</th>
				</tr>
				<tr>
					<th>Histidine</th>
					<th>H</th>
				</tr>
				<tr>
					<th>Isoleucin</th>
					<th>I</th>
				</tr>
				<tr>
					<th>Leucine</th>
					<th>L</th>
				</tr>
				<tr>
					<th>Lysine</th>
					<th>K</th>
				</tr>
				<tr>
					<th>Methionine</th>
					<th>M</th>
				</tr>
				<tr>
					<th>Phenylalanine</th>
					<th>F</th>
				</tr>
				<tr>
					<th>Proline</th>
					<th>P</th>
				</tr>
				<tr>
					<th>Serine</th>
					<th>S</th>
				</tr>
				<tr>
					<th>Threonine</th>
					<th>T</th>
				</tr>
				<tr>
					<th>Tryptophan</th>
					<th>W</th>
				</tr>
				<tr>
					<th>Tyrosine</th>
					<th>Y</th>
				</tr>
				<tr>
					<th>Valine</th>
					<th>V</th>
				</tr>
				<tr>
					<th>Alanine</th>
					<th>A</th>
				</tr>
			</tbody>
		</table>

	</div>
	<div class="modal-footer">
		<a href="#!" class="modal-close waves-effect waves-green btn-flat">Close</a>
	</div>
	</div>								   

	<br>
	<br>
	<br>
	<div class="row">
	  <div id="mutation" class="input-field col s12">
	    <input type="text" name="mutations" class="validate" placeholder="X:123Y, A:45B" >
	    <label for="mutations">Enter comma separated list of mutations</label>
	  </div>
	</div>
	<br>
      </div>
    </li>


	<!-- SEQUENCE ALIGNMENT -->

    <li>
      <div class="collapsible-header grey lighten-4">
		<h5 class="center-align"> Sequence alignment </h5>
      </div>
      <div class="collapsible-body">
	<h4> <button data-target="modal2" class="btn-small modal-trigger grey lighten-1" title="Further information" style="float:right;">info</button> </h4>
	<!-- Modal Structure -->
	<div id="modal2" class="modal">
	  <div class="modal-content">
	    <h4>Define mutations by sequence alignment</h4>
	    <p>You can mutate the model that you uploaded in previous step using a sequence alignment in ClustalW format.<br>
	      One of the sequences in the alignment has to match exactly one sequence in the PDB that you uploaded in previous step.<br>
	      Since one alignment is associated with one chain, you can upload up to three alignments.<br>
	      If you need to mutate more than three chains, you can upload target sequences for the other chains or define mutations manually. </p>
	  </div>
	  <div class="modal-footer">
	    <a href="#!" class="modal-close waves-effect waves-green btn-flat">Close</a>
	  </div>
	</div>

	<br>
	
    <div class="row">
      <div class="col offset-s3 s6">
	<div class="file-field input-field" style="width: 100%">
	  <div class="btn" style="width: 100%">
	    <span>Upload a ClustalW file</span>
	    <input type="file" name="clustal1">
	  </div>
	</div>
      </div>

		<div class="col offset-s3 s6">
			<div class="file-field input-field additional clw1" style="width: 100%">
				<div class="btn" style="width: 100%">
					<span>Upload a ClustalW file</span>
					<input type="file" name="clustal2">
				</div>
			</div>
		</div>

		<div class="col offset-s3 s6">
			<div class="file-field input-field additional clw2" style="width: 100%">
				<div class="btn" style="width: 100%">
					<span>Upload a ClustalW file</span>
					<input type="file" name="clustal3">
				</div>
			</div>
		</div>

		<div style="width: 100%; display: flex; justify-content: center">
			<div id="add-clw" style="margin-top: 2rem">
				<a class="btn-small grey lighten-1" onclick="addAlignments()">Add more Alignments</a>
			</div>
		</div>

    </div>
	
    </li>

    

	<!-- TARGET SEQUENCE -->
	
    <li>
      <div class="collapsible-header grey lighten-3">
	<h5 class="center-align"> Target sequence</h5>
      </div>
      <div class="collapsible-body">
 	
	<br>


	<!-- 1) FASTA uploads -->
	<div>
	  <div class="row">
	    <div class="col s3">
	      <div class="input-field chain-select-field" sel="chainF1">
		<!--<select id="chainF1"></select>-->
		<!--<input id="chainF1" type="text" name="chainF1" class="validate" >
		<label for="chainF1">PDB Chain</label>-->
	
	      </div>
	    </div>
	    <div class="col s6">
	      <div class="file-field input-field" style="width: 100%">
		<div class="btn" style="width: 100%">
		  <span>Upload a FASTA file</span>
		  <input type="file" name="fasta1">
		</div>
	      </div>
	    </div>
	  </div>
	  
	  <div class="row additional fasta1">
	    <div class="col s3">
	      <div class="input-field chain-select-field" sel="chainF2">
		<!--<select id="chainF2"></select>-->
		<!--<input id="chainF2" type="text" name="chainF2" class="validate" >
		<label for="chainF2">PDB Chain</label>-->
	      </div>
	    </div>
	    <div class="col s6">
	      <div class="file-field input-field" style="width: 100%">
		<div class="btn" style="width: 100%">
		  <span>Upload a FASTA file</span>
		  <input type="file" name="fasta2">
		</div>
	      </div>
	    </div>
	  </div>
	  
	  <div class="row additional fasta2">
	    <div class="col s3">
	      <div class="input-field chain-select-field" sel="chainF3">
		<!--<select id="chainF3">
		  <option value="" disabled selected>PDB chain</option>
		</select> -->

		<!--
		<input id="chainF3" type="text" name="chainF3" class="validate" >
		<label for="chainF3">PDB Chain</label>-->


	      </div>
	    </div>
	    <div class="col s6">
	      <div class="file-field input-field" style="width: 100%">
		<div class="btn" style="width: 100%">
		  <span>Upload a FASTA file</span>
		  <input type="file" name="fasta3">
		</div>
	      </div>
	    </div>
	  </div>
	  
	  <div style="width: 100%; display: flex; justify-content: center">
	    <div id="add-fasta" style="margin-bottom: 2rem">
	      <a class="btn-small grey lighten-1" onclick="addFastas()">Add more FASTAs</a>
	    </div>
	  </div>
	</div>
	
	<br>
	
	<!-- 2) Sequence upload -->
	<div>
	  <div class="row">
	    <div class="col s3">
	      <div class="input-field chain-select-field" sel="chainS1">
			<!--
		<input id="chainS1" type="text" name="chainS1" class="validate" >
		<label for="chainS1">PDB Chain</label> -->
		<!--<select id="chainS1"></select>-->
	      </div>
			</div>
			<div class="col s9">
				<div class="input-field">
					<input id="seq1" type="text" name="sequence1" class="validate" placeholder="ABBA...ACDC">
					<label for="seq1"> Paste a sequence</label>
				</div>
			</div>
		</div>

		<div class="row additional pseq1">
			<div class="col s3">
				<div class="input-field chain-select-field" sel="chainS2">
					<!--
					<input id="chainS2" type="text" name="chainS2" class="validate" >
					<label for="chainS2">PDB Chain</label>-->
				</div>
			</div>
			<div class="col s9">
				<div class="input-field">
					<input id="seq2" type="text" name="sequence2" class="validate" placeholder="ABBA...ACDC">
					<label for="seq2"> Paste a sequence</label>
				</div>
			</div>
		</div>

		<div class="row additional pseq2">
			<div class="col s3">
				<div class="input-field chain-select-field" sel="chainS3">
					<!--
					<input id="chainS3" type="text" name="chainS3" class="validate" >
					<label for="chainS3">PDB Chain</label>-->
				</div>
			</div>
			<div class="col s9">
				<div class="input-field">
					<input id="seq3" type="text" name="sequence3" class="validate" placeholder="ABBA...ACDC">
					<label for="seq3"> Paste a sequence</label>
				</div>
			</div>
		</div>

		<div style="width: 100%; display: flex; justify-content: center">
			<div id="add-seq" style="margin-bottom: 2rem">
				<a class="btn-small grey lighten-1" onclick="addSequences()">Add more Sequences</a>
			</div>
		</div>
	</div>

	<br>

	<!-- 3) Uniprot upload -->
	<div>
		<div class="row">
			<div class="col s3">
				<div class="input-field chain-select-field" sel="chainU1">
					<!--
					<input id="chainU1" type="text" name="chainU1" class="validate" >
					<label for="chainU1">PDB Chain</label>-->
				</div>
			</div>
			<div class="col s9">
				<div class="input-field">
					<input id="U1" type="text" name="uniprot1" class="validate" placeholder="Uniprot ID">
					<label for="U1">Load sequence from UniProt</label>
				</div>
			</div>
		</div>

		<div class="row additional up1">
			<div class="col s3">
				<div class="input-field chain-select-field" sel="chainU2">
					<!--
					<input id="chainU2" type="text" name="chainU2" class="validate" >
					<label for="chainU2">PDB Chain</label>-->
				</div>
			</div>
			<div class="col s9">
				<div class="input-field">
					<input id="U2" type="text" name="uniprot2" class="validate" placeholder="Uniprot ID">
					<label for="U2">Load sequence from UniProt</label>
				</div>
			</div>
		</div>

		<div class="row additional up2">
			<div class="col s3">
				<div class="input-field chain-select-field" sel="chainU3">
					<!--
					<input id="chainU3" type="text" name="chainU3" class="validate" >
					<label for="chainU3">PDB Chain</label>-->
				</div>
			</div>
			<div class="col s9">
				<div class="input-field">
					<input id="U3" type="text" name="uniprot3" class="validate" placeholder="Uniprot ID">
					<label for="U3">Load sequence from UniProt</label>
				</div>
			</div>
		</div>

		<div style="width: 100%; display: flex; justify-content: center">
			<div id="add-up" style="margin-bottom: 2rem">
				<a class="btn-small grey lighten-1" onclick="addUniprots()">Add more Uniprots</a>
			</div>
		</div>
	</div>

	

    </li>
    
    
   </ul>
   <br>


   <div id="status-info"><h5 style="color:blue;">{{status}}</h5> </div>



   
   <div class="col offset-s3 s6 center-align">
     <input id="submit-btn" type="submit" value="submit and launch explorer" class="btn">
   </div>
<br>
<br>
 
 </form>
</div>

<br>
<br>
<div style="width:100%;">
  <h5> Link to results </h5>
</div>
<p>Copy this link for later to access your results <br>(not available before the job is finished): <br>
  https://proteinformatics.uni-leipzig.de{{url_for('explore',tag=tag,filename='mut_0_1.pdb')}}
</p>

<h5> Rough time estimate </h5>
<ul>
  <li> Initial basic minimization prior to mutation: 1 min </li>
  <li> Mutation followed by basic minimization: 2 min  </li>
</ul>
<p> Details can be found in the FAQs </p>

<br>
<br>
<br>
<br>
<br>
<br>


{% endblock %}

{% block scripts %}

<script>


  var aligns = 0;
  var fastas = 0;
  var seqs = 0;
  var uniprots = 0;

  document.getElementById( 'chain_list').innerHTML = "{{chains}}".replace( /,/g, '<br/>');  // .split('');

  chainSelect();
  
  function addOpt( target){
      if(!target){
          return false;
      }
      var chains = "{{chains}}";
      var select =  document.getElementById(target);
      select.add( new Option( 0, 'Chain in PDB'));
      for (var i = 0; i < chains.length; i++)
      {
	   select.options.add(new Option( i, chains.charAt(i)));
           //var opt = document.createElement('option');
           //opt.value = i;
           //opt.innerHTML = chains.charAt(i);
           //select.appendChild(opt);
           //alert( target + ' ' + i + ' ' + chains.charAt(i) + ' ' + opt.innerHTML );
      }
      M.FormSelect.init( select);
  }
  //addOpt('chainF1');
  //addOpt('chainF2');
  //addOpt('chainS1');

  initUploads();


  
	function addAlignments() {
		aligns += 1;
		$(".clw" + aligns).removeClass("additional");
		if (aligns == 2) {
			$("#add-clw").css("display", "none");
		}
	}

	function addFastas() {
		fastas += 1;
		$(".fasta" + fastas).removeClass("additional");
		if (fastas == 2) {
			$("#add-fasta").css("display", "none");
		}
	}

	function addSequences() {
		seqs += 1;
		$(".pseq" + seqs).removeClass("additional");
		if (seqs == 2) {
			$("#add-seq").css("display", "none");
		}
	}

	function addUniprots() {
		uniprots += 1;
		$(".up" + uniprots).removeClass("additional");
		if (uniprots == 2) {
			$("#add-up").css("display", "none");
		}
	}

	// showFilename, initUploads are slightly different to submit.html versions
    function showFilename() {
        var fname = $(this).val().replace(/^.*[\\\/]/, '')
        $(this).parent().parent().parent().find(".filename").html(fname)
    }

    function initUploads() {
        var uploads = $(".file-field")
        for (i = 0; i < uploads.length; i++) {
            $(uploads[i]).parent().append('<center><div class="filename"></div></center>')
            $($(uploads[i]).find("input")).on("change", showFilename)
        }
    }


	function chainSelect() {

		var chains = "{{chains}}".split("")
		var selectHtml = "<select name='XYZ'><option value='' selected>Select a Chain</option>"
		for (i = 0; i < chains.length; i++) {
			c = chains[i]
			selectHtml += "<option value='" + c + "'>" + c + "</option>"
		}
		selectHtml += "</select>"

		var fields = $(".chain-select-field")
		for (i = 0; i < fields.length; i++) {
			sel = $(fields[i]).attr("sel")
			$(fields[i]).append(selectHtml.replace("XYZ", sel))
		}

      	$('select').formSelect();
	}



</script>


{% endblock %}
