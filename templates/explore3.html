{% extends "base.html" %}

{% block head %}
<link rel="stylesheet" type="text/css" href="https://molstar.org/viewer/molstar.css" />
<link rel="stylesheet" type="text/css" href="{{url_for('static', filename='css/exploreStyle.css')}}" media="all">
{% endblock %}


{% block content %}

<center>
<h1>Explore {{tag}}</h1>
</center>

<div class="row">

<div class="col s3">



    <div id="mutation-view">
        <form id="submitForm" method="POST" enctype="multipart/form-data" target="_blank">
        <h4 class="center-align">Mutate</h4>
        <div class="input-field">
            <input type="text" name="mutations" class="validate" placeholder="X:123Y; A:45B" required>
            <label for="chain">Enter Mutations</label>
        </div>

        <div class="input-field">
            <input id="chain" type="text" name="structure" class="validate" placeholder="structure.pdb" required>
            <label for="chain">Enter the Source Structure</label>
        </div>

        <div class="input-field">
            <input id="name" type="text" name="name" class="validate" placeholder="(optional)" pattern="^[a-zA-Z0-9 ]+$">
            <label for="name">Name the new Structure</label>
        </div>

        <div class="center-align">
            <input id="submit-btn" type="submit" value="submit" class="btn" form="submitForm">
        </div>
        </form>
    </div>


    <div id="tree-viewer">
        <h4 class="center-align">Structures</h4>

        {{structures|safe}}

        <div class="center-align">
            <a id="res-download" href="{{url_for('download', tag = tag, filename = 'results' + tag + '.zip')}}" download class="btn">download all</a>
        </div>
    </div>
</div>

<div class="col s9">
    <div id="viewport"></div>

    <div id="strc-download">
        <a href="{{url_for('download', tag = tag, filename = 'structure.pdb')}}" download class="btn inv">download structure</a>
    </div>
</div>

</div>




{% endblock %}


{% block scripts %}
<script type="text/javascript" src="https://molstar.org/viewer/molstar.js"></script>

<script type="text/javascript">

    import { DefaultPluginUISpec, PluginUISpec } from 'molstar/lib/mol-plugin-ui/spec';
    import { createPluginAsync } from 'molstar/lib/mol-plugin-ui/index';
    import { PluginConfig } from 'molstar/lib/mol-plugin/config';


    function getURL(fname) {
        var loc = window.location;
        var command = loc.protocol + "//" + loc.host + "{{url_for('download', tag=tag, filename='')}}" + fname; 
        return command;
    }

    const MySpec = {
        ...DefaultPluginUISpec(),
        config: [
            [PluginConfig.VolumeStreaming.Enabled, false]
        ]
    }


    async function createPlugin(parent) {
        const plugin = await createPluginAsync(parent, MySpec);

        const data = await plugin.builders.data.download({ url: '...' }, { state: { isGhost: true } });
        const trajectory = await plugin.builders.structure.parseTrajectory(data, format);
        await this.plugin.builders.structure.hierarchy.applyPreset(trajectory, 'default');

        return plugin;
    }

    createPlugin($("viewport")); // app is a <div> element


    async function loadPdb(name) {
        viewer = await vviewer;

        viewer.plugin.clear()

        //x = getURL("structure.pdb")
        x = "files.rcsb.org/download/3SN6.pdb"
        console.log(x)
        p = {x}
        data = await viewer.plugin.builders.data.download(p)
        console.log("data")
        console.log(data)
        trajectory = await viewer.plugin.builders.structure.parseTrajectory(data, "pdb")
        model = await viewer.plugin.builders.structure.createModel(trajectory)
        console.log("model")
        console.log(model)
        structure = await viewer.plugin.builders.structure.createStructure(model)
        console.log("structure")
        console.log(structure)

        component = await viewer.plugin.builders.structure.tryCreateComponentStatic(structure, 'ligand')
        /*
        const components = {
            polymer: await viewer.plugin.builders.structure.tryCreateComponentStatic(structure, 'polymer'),
            ligand: await viewer.plugin.builders.structure.tryCreateComponentStatic(structure, 'ligand'),
            water: await viewer.plugin.builders.structure.tryCreateComponentStatic(structure, 'water'),
        };*/

        builder = viewer.plugin.builders.structure.representation
        update = viewer.plugin.build()

        /*
        if (components.polymer) builder.buildRepresentation(update, components.polymer, { type: 'gaussian-surface', typeParams: { alpha: 1} }, { tag: 'polymer' });
        if (components.ligand) builder.buildRepresentation(update, components.ligand, { type: 'ball-and-stick' }, { tag: 'ligand' });
        if (components.water) builder.buildRepresentation(update, components.water, { type: 'ball-and-stick', typeParams: { alpha: 1} }, { tag: 'water' });
        */
       builder.buildRepresentation(update, component, { type: 'gaussian-surface' }, { tag: 'strc'} )

        //builder.buildRepresentation(update, component, { type: 'gaussian-surface', color: 'uncertainty'})

        await update.commit()
        console.log("update()")


        /*
        viewer.then(function(val) {
            val.plugin.clear()
            //val.loadStructureFromUrl(getURL(name), format='pdb')

            x = getURL("structure.pdb")
            p = {x}
            data = await val.plugin.builders.data.download(p)
            console.log("data")
            console.log(data)
            //trajectory = val.plugin.builders.structure.parseTrajectory(data, "pdb")
            model = val.plugin.builders.structure.createModel(data)
            console.log("model")
            console.log(model)
            structure = val.plugin.builders.structure.createStructure(model)
            console.log("structure")
            console.log(structure)

            component = val.plugin.builders.structure.tryCreateComponentStatic(structure, 'polymer')

            builder = val.plugin.builders.structure.representation
            update = val.plugin.build()
            builder.buildRepresentation(update, component, { type: 'gaussian-surface', color: 'uncertainty'})
            update.commit()
        }) */
    }
    
    $(".structures").click(function(e) {
        e.preventDefault()
        name = $(this).text()
        //href = $("#strc-download a").attr("href")
        $("#strc-download a").attr("href", getURL(name))
        $("#strc-download a").text("download " + name)
        $("#strc-download a").removeClass("inv")

        $(".structures").removeClass("bld")
        $(this).addClass("bld")
        loadPdb(name)
    })


</script>




{% endblock %}