{% extends "base.html" %}

{% block head %}
<link rel="stylesheet" type="text/css" href="https://molstar.org/viewer/molstar.css" />
<link rel="stylesheet" type="text/css" href="{{url_for('static', filename='css/exploreStyle.css')}}" media="all">
{% endblock %}


{% block content %}

<div class="row whole-container grey lighten-5">
  
  <div class="col s3 sidebar card">
    
    <div id="tree-viewer" >
      <h4 class="center-align toggle-card">Select  <a class="waves-effect waves-light btn modal-trigger grey lighten-2" href="#modal1" title="Further information" style="float:right;">i</a></h4>

      <!-- Modal Structure -->
      <div id="modal1" class="modal">
	<div class="modal-content">
	  <h4>Select a variant to be displayed</h4>
	  <p>First you select the variant to be displayed from the list.<br>
	    mut_0: is the original protein that you uploaded<br>
	    mut_0_1: the first mutation you applied to the original model (this was created during first upload)<br>
	    mut_0_1_1: would be a further mutation applied to mut_0_1<br>
	    mut_0_2: the second independent mutation applied to mut_0<br>
	    The last variant created is displayed by default.</p>
	  <h4> Select coloring scheme </h4>
	  <p> You can color either by energy or by hydrophobicity.<br>
	    For each you can choose between the difference of mutated to original or the absolute value.<br>
	    The default is coloring by energy difference.<br> </p>
	  <p> For each combination variant/coloring, there is a PDB file in the download. <br>
	  The values used for the coloring are written in beta-factor column, respectively.</p>
	</div>
	<div class="modal-footer">
	  <a href="#!" class="modal-close waves-effect waves-green btn-flat">Close</a>
	</div>
      </div>
 
      <div>
	
	{{structures|safe}}
	
	<div class="input-field">
	  <select id="selecter" onchange="changeColoring();">
	    <option value="" disabled selected>Color by</option>
	    <option value="1">Absolute energy</option>
	    <option value="2">Energy difference to parent</option>
	    <option value="3">Absolute hydrophobicity</option>
	    <option value="4">Difference in hydrophobicity</option>
	  </select>
	</div>
	
	<div>
	  <p>Currently displayed:</p>
	  <div id="discol">n o t h i n g</div>
	</div>
	
	<div class="center-align">
          <a id="res-download" href="{{url_for('download', tag = tag, filename = 'results' + tag + '.zip')}}" download class="btn">download all</a>
	</div>
	
      </div>
    </div>
    
    
    <div id="mutation-view">
      <form id="submitForm" method="POST" enctype="multipart/form-data" target="_blank">
        <h4 class="center-align toggle-card">Mutate   <button data-target="modal2" class="btn modal-trigger grey lighten-2" title="Further information" style="float:right;">i</button> </h4>
	<!-- Modal Structure -->
	<div id="modal2" class="modal">
	  <div class="modal-content">
	    <h4>Mutate current model</h4>
	    <p>First, select the model you want to mutate in the section 'Select'. <br> Then you can mutate the current model using the syntax:<br> CHAIN ':' PDB-RESIDUE-ID AA-TYPE<br>Separate multiple mutations with commas.<br>Example: 'A:12G,B:123A'<br>This would mutate residue with the PDB residue ID 12 in chain A to glycine and residue with the ID 123 in chain B to alanine. </p>
	  </div>
	  <div class="modal-footer">
	    <a href="#!" class="modal-close waves-effect waves-green btn-flat">Close</a>
	  </div>
	</div>


	<div>
          <div class="input-field">
            <input type="text" name="mutations" class="validate" placeholder="X:123Y; A:45B" required>
            <label for="chain">Enter mutations</label>
          </div>

	  <!--
          <div class="input-field">
            <input id="chain" type="text" name="structure" class="validate" placeholder="mut_0.pdb" required>
            <label for="chain">Source structure (from 'Select' list with '.pdb' ending)</label>
          </div>

          <div class="input-field">
            <input id="name" type="text" name="name" class="validate" placeholder="(optional)" pattern="^[a-zA-Z0-9 ]+$">
            <label for="name">Name new structure</label>
          </div>
	  -->

          <div class="center-align">
            <input id="submit-btn" type="submit" value="submit" class="btn" form="submitForm">
          </div>
        </div>
      </form>
    </div>


    <div id="info-view">
      <h4 class="center-align toggle-card">Info   <button data-target="modal3" class="btn modal-trigger grey lighten-2" style="float:right;"title="Further information">i</button> </h4>
	<!-- Modal Structure -->
	<div id="modal3" class="modal">
	  <div class="modal-content">
	    <h4>Additional information about the current model</h4>
	    <p> First, the parent of the current model is listed.<br>
	      Second, the mutations applied to the parent are listed.<br>
	      Third, the job ID is listed.</p>
	  </div>
	  <div class="modal-footer">
	    <a href="#!" class="modal-close waves-effect waves-green btn-flat">Close</a>
	  </div>
	</div>

      <span>Parent: {{parent}} </span>
      
      <br>
      
      <span>Mutations: {{mutations}} </span>
      
      <br>
      
      <span>Exploration: {{tag }} </span>
      
    </div>
    <br>
    <br>
    
  </div>

  <div class="col s9">
    <div id="viewport"></div>
  </div>
  
  
</div>




{% endblock %}


{% block scripts %}
<script type="text/javascript" src="https://molstar.org/viewer/molstar.js"></script>

<script type="text/javascript">
  
  $(document).ready(function(){
      $('select').formSelect();
  });

  
  function getURL(fname) {
      var loc = window.location;
      var command = loc.protocol + "//" + loc.host + "{{url_for('download', tag=tag, filename='')}}" + fname;
      return command;
  }

  
  var viewer = new molstar.Viewer.create('viewport', {
        layoutIsExpanded: false,
        layoutShowControls: false,
        layoutShowRemoteState: false,
        layoutShowSequence: true,
        layoutShowLog: false,
        layoutShowLeftPanel: true,

        viewportShowExpand: true,
        viewportShowSelectionMode: false,
        viewportShowAnimation: false,

        pdbProvider: 'rcsb',
        emdbProvider: 'rcsb',
  });    

  
  function loadPdb(name) {
        viewer.then(function(val) {
            val.plugin.clear()
            val.loadStructureFromUrl(getURL(name), format='pdb')
        })
  }

  
  $(".toggle").click(function(e) {
        l = $(this).parent().next()
        // if is redundant
        if (l.children().length > 0) {
            $(this).toggleClass("rot")
            l.toggleClass("non")
        }
  })

  $(".toggle-card").click(function() {
        $(this).next().toggleClass("non")
  })

  
  let the_ending = "_absE.pdb"; // for communication between 2 fct below
  name = "{{filename}}";
  let the_name = name.substr(0,name.length - 4);
  document.getElementById('discol').innerHTML = the_name + the_ending;
  loadPdb( the_name + the_ending);

  
  $(".structures").click(function(e) {
      e.preventDefault();
      this_name = $(this).text();
      strc = this_name + the_ending;
      // highlight:
      $(".structures").removeClass("bld");  // unbold all
      $(this).addClass("bld");              // bold current
      // load:
      loadPdb(strc);
      document.getElementById('discol').innerHTML = strc;
      loadPdb( strc );
  })

  
  function changeColoring() {
      var selectBox = document.getElementById("selecter");
      var selected = selectBox.options[selectBox.selectedIndex];
      var selectedText = selected.innerHTML;
      var id = selected.value;
      if( id == "1"){ the_ending = "_absE.pdb";}
      else if( id == "2"){ the_ending = "_diffE.pdb";}
      else if( id == "3"){ the_ending = "_HyPh.pdb"; }
      else if( id == "4"){ the_ending = "_diffHyPh.pdb"; }
      //alert(selectedValue);
      document.getElementById('discol').innerHTML = the_name + the_ending;
      loadPdb( the_name + the_ending );
  }

  
</script>




{% endblock %}
