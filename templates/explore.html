{% extends "base.html" %}

{% block head %}
<link rel="stylesheet" type="text/css" href="https://molstar.org/viewer/molstar.css" />
<link rel="stylesheet" type="text/css" href="{{url_for('static', filename='css/exploreStyle.css')}}" media="all">
{% endblock %}


{% block content %}

<center>
<h1>Explore {{tag}}</h1>
</center>

<div class="row">

<div class="col s3">



    <div id="mutation-view">
        <form id="submitForm" method="POST" enctype="multipart/form-data" target="_blank">
        <h4 class="center-align toggle-card">Mutate</h4>
        <div>
            <div class="input-field">
                <input type="text" name="mutations" class="validate" placeholder="X:123Y; A:45B" required>
                <label for="chain">Enter Mutations</label>
            </div>

            <div class="input-field">
                <input id="chain" type="text" name="structure" class="validate" placeholder="structure.pdb" required>
                <label for="chain">Enter the Source Structure (from list below)</label>
            </div>

            <div class="input-field">
                <input id="name" type="text" name="name" class="validate" placeholder="(optional)" pattern="^[a-zA-Z0-9 ]+$">
                <label for="name">Name the new Structure</label>
            </div>

            <div class="center-align">
                <input id="submit-btn" type="submit" value="submit" class="btn" form="submitForm">
            </div>
        </div>
        </form>
    </div>


    <div id="tree-viewer">
        <h4 class="center-align toggle-card">Structures</h4>
        <div>

            {{structures|safe}}

            <div class="center-align">
                <a id="res-download" href="{{url_for('download', tag = tag, filename = 'results' + tag + '.zip')}}" download class="btn">download all</a>
            </div>
    
        </div>
    </div>
</div>

<div class="col s9">
    <div id="viewport"></div>

    <div id="strc-download">
        <a href="{{url_for('download', tag = tag, filename = 'structure.pdb')}}" download class="btn inv">download structure</a>
    </div>
</div>

</div>




{% endblock %}


{% block scripts %}
<script type="text/javascript" src="https://molstar.org/viewer/molstar.js"></script>

<script type="text/javascript">

    function getURL(fname) {
        var loc = window.location;
        var command = loc.protocol + "//" + loc.host + "{{url_for('download', tag=tag, filename='')}}" + fname; 
        return command;
    }

    var viewer = new molstar.Viewer.create('viewport', {
        layoutIsExpanded: false,
        layoutShowControls: false,
        layoutShowRemoteState: false,
        layoutShowSequence: true,
        layoutShowLog: false,
        layoutShowLeftPanel: true,

        viewportShowExpand: true,
        viewportShowSelectionMode: false,
        viewportShowAnimation: false,

        pdbProvider: 'rcsb',
        emdbProvider: 'rcsb',
    });    

    function loadPdb(name) {
        viewer.then(function(val) {
            val.plugin.clear()
            val.loadStructureFromUrl(getURL(name), format='pdb')
        })
    }
    
    $(".structures").click(function(e) {
        e.preventDefault()
        name = $(this).text()
        //href = $("#strc-download a").attr("href")
        strc = name + ".pdb"
        $("#strc-download a").attr("href", getURL(strc))
        $("#strc-download a").text("download " + strc)
        $("#strc-download a").removeClass("inv")

        $(".structures").removeClass("bld")
        $(this).addClass("bld")
        loadPdb(strc)
    })

    $(".toggle").click(function(e) {
        l = $(this).parent().next()
        // if is redundant
        if (l.children().length > 0) {
            $(this).toggleClass("rot")
            l.toggleClass("non")
        }
    })

    $(".toggle-card").click(function() {
        $(this).next().toggleClass("non")
    })

</script>




{% endblock %}
