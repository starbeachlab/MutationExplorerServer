{% extends "base.html" %}

{% block content %}

<center>
<br>
<h3>Upload structure or model</h3>



<br>
<p> Choose one of the following options: </p>
</center>



<form id="submitForm" method="POST" enctype="multipart/form-data" class="row">

<div class="col s6">

    <center>
    <h5>Base sequence</h5>
    </center>

    <!-- Seq select -->
	  <div class="input-field seq-select-field" sel="base_seq"></div>

    <br>
    <br>
    <br>
    <br>
    
    <center>
    <h5>Base structure</h5>
    </center>

    <!-- Upload -->
    <div style="width: 100%; display: flex; justify-content: center">
    <div class="file-field input-field" style="width: 100%">
        <div class="btn" style="width: 100%">
            <span>Upload a PDB file</span>
            <input id="pdb-upl" type="file" name="base_pdbfile">
        </div>
    </div>
    </div>

    <!-- PDB -->
    <div class="input-field">
        <input id="pdb-id" type="text" name="base_pdbid" class="validate" placeholder="PDB ID (without '.pdb' ending, example: '1afo')">
        <label for="chain">Load structure from PDB</label>
    </div>

    <!-- AF -->
    <div class="input-field">
        <input id="af-id" type="text" name="base_alphafoldid" class="validate" placeholder="Uniprot ID">
        <label for="chain">Load prediction from AlphaFold DB</label>
    </div>

    <!-- Chain -->
    <div class="input-field">
        <input id="chain" type="text" name="base_chain" class="validate">
        <label for="chain">Enter chain</label>
    </div>

</div>


<div class="col s6">

    
    <center>
    <h5>Target sequence</h5>
    </center>

    <!-- Seq select -->
	  <div class="input-field seq-select-field" sel="target_seq"></div>

    <br>
    <br>
    <br>
    <br>
    
    <center>
    <h5>Target structure (optional)</h5>
    </center>

    <!-- Upload -->
    <div style="width: 100%; display: flex; justify-content: center">
    <div class="file-field input-field" style="width: 100%">
        <div class="btn" style="width: 100%">
            <span>Upload a PDB file</span>
            <input id="pdb-upl" type="file" name="target_pdbfile">
        </div>
    </div>
    </div>

    <!-- PDB -->
    <div class="input-field">
        <input id="chain" type="text" name="target_pdbid" class="validate" placeholder="PDB ID (without '.pdb' ending, example: '1afo')">
        <label for="chain">Load structure from PDB</label>
    </div>

    <!-- AF -->
    <div class="input-field">
        <input id="chain" type="text" name="target_alphafoldid" class="validate" placeholder="Uniprot ID">
        <label for="chain">Load prediction from AlphaFold DB</label>
    </div>

    <!-- Chain -->
    <div class="input-field">
        <input id="chain" type="text" name="target_chain" class="validate">
        <label for="chain">Enter chain</label>
    </div>

</div>
                



<div id="radio-field" class="input-field col offset-s3 s6" style="margin-top: 3rem !important">
  <span id="radio-title" class="grey-text text-darken-1">Minimization <a class="waves-effect waves-light btn modal-trigger grey lighten-2" href="#modalmin" title="Further information" style="float:right;">i</a></span>

      <!-- Modal Structure -->
      <div id="modalmin" class="modal">
	<div class="modal-content">
	  <h4>Minimization</h4>
	  <p>
	    The minimization is crucial for the quality of the outcome. The better the structure is energetically minimized, the more reliable the results will be. <br><br>
	    If you select <b> none </b>, coloring the structures by energy or energy difference is possible but does not provide reliable information. <br><br>

	    We continuously pre-minimize structures from the PDB using the commandline described below.
	    If you specify a PDB ID that is contained in our database, the pre-minimized structure is used. <br>
	    Otherwise we offer two modes of side-chain minimization, a short and a long one. The short one should take a few minutes, depending on the size of the protein. The long one may take some hours for large proteins. 
	  </p>
	  <h4> AlphaFold and your own models</h4>
	  <p>These are not pre-minimized and you should follow the steps below. The AlphaFold models should be minimized, but the minimization has to be performed with the same energy functions than we use in the <span class="mut-ex">MutationExplorer</span>, namely Rosetta. </p>
	  
	  <h4> Do it yourself!</h4>
	  <p> The minimizations we offer as 'long' and 'short' are both only side-chain optimizations.
	    However, we recommend you to perform the following minimization. It is optimizing also the backbone in a limited way (due to '-relax:constrain_relax_to_start_coords'). A free backbone minimization might be leading to problems for e.g. membrane proteins. </p>
	  <div class="codebox">
	    <code>
	      PATH_TO_ROSETTA/relax.static.linuxgccrelease   -relax:fast true -relax:cartesian true -score:weights ref2015_cart -use_input_sc -optimization::default_max_cycles 200 -linmem_ig 10 -relax:constrain_relax_to_start_coords -ex1 -ex2  -nstruct 20 -in:file:s  INPUT.pdb -out:pdb -out:prefix  OUTDIR/
	    </code>
	  </div>

	  <p>
	    This commandline will create 20 models, from which you should select the one with the lowest energy. Each PDB contains a line starting with 'pose'. In this line you want the last value, which is the total energy.</p>
	  
	</div>
	<div class="modal-footer">
	  <a href="#!" class="modal-close waves-effect waves-green btn-flat">Close</a>
	</div>
      </div>
  
  <p>
    <label>
      <input type="radio" name="min-selector" value="none" checked required />
      <span>none (visualize sequence conservation and hydrophobicity)</span>
    </label>
  </p>
  <p>
    <label>
      <input type="radio" name="min-selector" value="long" />
      <span>long (5-60 min, recommended)</span>
    </label>
  </p>
  <p>
    <label>
      <input type="radio" name="min-selector" value="short" />
      <span>quick (1-3 min)</span>
    </label>
  </p>
  <p>
    <label>
      <input type="radio" name="min-selector" value="none" />
      <span>none<span>
    </label>
  </p>

</div>
<div id="radio-field" class="input-field col offset-s3 s6">
  <span id="radio-title" class="grey-text text-darken-1">RaSP Model <a class="waves-effect waves-light btn modal-trigger grey lighten-2" href="#modalrasp" title="Further information" style="float:right;">i</a></span>
  
  <!-- Modal Structure -->
      <div id="modalrasp" class="modal">
	<div class="modal-content">
	  <h4>RaSP model</h4>
	  <p>
	   RaSP is a deep-learning-based tool that rapidly estimates
protein stability changes. With RaSP, Mutation Explorer presents the user with a quick initial estimation of a mutation's (de)stabilizing effect, without their having to wait for the longer full minimization process.  The RaSP tool consists of two linearly linked networks.  A self-supervised 3D convolutional neural network that has learned representations of protein structures is followed by a fully connected neural network that maps these internal representations to Rosetta protein stability changes. RaSP is optimised for accuracy in the range [-1,7] kcal/mol.	   
	   </p>
	    <p>
	    This command will create a RaSP model for each chain of the structure. This can take up to 10 minutes per chain.</p>
	    <p>Once this option is selected, it will be applied in all subsequent steps accordingly.</p>
  	</div>
	<div class="modal-footer">
	  <a href="#!" class="modal-close waves-effect waves-green btn-flat">Close</a>
	</div>
      </div>
  
     <p>
    <label>
      <input type="checkbox" name="rasp-checkbox"  />
      <span>Calculate RaSP model (~10 min per chain)</span>
    </label>
  </p>
</div>

<div class="col offset-s3 s6 center-align">
  <div id="error-msg" style="color: red;">{{error}}</div>
<input id="submit-btn" type="submit" value="submit" class="btn">
<br>
<br>

</form>



{% endblock %}

{% block scripts %}

<script>

    function showFilename() {
        var fname = $(this).val().replace(/^.*[\\\/]/, '')
        $(this).parent().parent().find(".filename").html(fname)
    }

    function initUploads() {
        var uploads = $(".file-field")
        for (i = 0; i < uploads.length; i++) {
            $(uploads[i]).append('<center><div class="filename"></div></center>')
            $($(uploads[i]).find("input")).on("change", showFilename)
        }
    }

    initUploads()



	function chainSelect() {

		var seqs = "{{seqs}}".split(",")
		var selectHtml = "<select name='XYZ' onChange='seqSelected(this)'><option value='' selected disabled>Select Sequence</option>"
		for (i = 0; i < seqs.length; i++) {
			s = seqs[i]
			selectHtml += "<option value='" + s + "'>" + s + "</option>"
		}
		selectHtml += "</select>"

    // insert selects into .seq-select-field divs
    // set select name to "sel" attribute of div
		var fields = $(".seq-select-field")
		for (i = 0; i < fields.length; i++) {
			sel = $(fields[i]).attr("sel")
			$(fields[i]).append(selectHtml.replace("XYZ", sel))
		}

    $('select').formSelect();
	}

    chainSelect()






  var baseSeqSelected = false;
  var targetSeqSelected = false;


  function seqSelected(sel) {
    console.log("sequence selected");
    selectName = sel.parentElement.parentElement.attributes.sel.value;
    if(selectName == "base_seq") {
      baseSeqSelected = true;
    } else {
      targetSeqSelected = true;
    }
  }


  function structureProvided() {
    if($("#af-id").val() != "") {
      return true;
    } 
    if($("#pdb-id").val().length == 4) {
      return true;
    } 
    if($('#pdb-upl').get(0).files.length != 0) {
      return true;
    }
    return false;
  }


	$("#submitForm").on('submit', function(e) {
		if(!baseSeqSelected || !targetSeqSelected || !structureProvided()) {
			e.preventDefault();
			$("#error-msg").html("Please select a base and a target sequence and provide a base structure")
		} 
	});


    /*
    $("#pdb-upl").parent().parent().append('<center><div class="filename"></div></center>');

    $("#pdb-upl").on("change", function() {
        var fname = $(this).val().replace(/^.*[\\\/]/, '')
        $(this).parent().parent().find(".filename").html(fname)
    })*/

</script>

{% endblock %}
